<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FAForever Wiki{% endblock %}</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% if editor_mode %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    {% endif %}

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    {% block head %}{% endblock %}
</head>
<body class="{% if editor_mode %}editor-mode{% endif %}">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle" title="Toggle menu">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
            <a href="{{ url_for('main.home') }}" class="logo-link">
                <img src="{{ url_for('static', filename='assets/faf-logo.png') }}" alt="FAF" class="logo-img">
                <span class="logo-text">FAF <span>Wiki</span></span>
            </a>
        </div>

        <div class="header-center">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input type="text" class="search-input" placeholder="Search wiki...">
            </div>
        </div>

        <div class="header-right">
            <button class="header-btn" title="Notifications">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                </svg>
                <span class="notification-badge">3</span>
            </button>

            {% if current_user.is_authenticated %}
            <a href="{{ url_for('auth.logout') }}" class="user-menu">
                <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
                <span class="user-name">{{ current_user.username }}</span>
            </a>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="user-menu">
                <div class="user-avatar">?</div>
                <span class="user-name">Login</span>
            </a>
            {% endif %}
        </div>
    </header>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Current Location -->
            <div class="current-location">
                <div class="current-location-label">You are here</div>
                <div class="current-location-path">{{ current_path|default('Home') }}</div>
            </div>

            <!-- Main Navigation -->
            <nav class="sidebar-section">
                <div class="sidebar-title">Navigation</div>
                <ul class="nav-tree">
                    <li class="nav-item {{ 'expanded' if active_nav == 'home' }}">
                        <a href="{{ url_for('main.home') }}" class="nav-link {{ 'active' if active_nav == 'home' }}">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                            </svg>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>

                    <li class="nav-item {{ 'expanded' if 'getting-started' in (active_nav or '') }}">
                        <a href="{{ url_for('main.getting_started') }}" class="nav-link {{ 'active' if active_nav == 'getting-started' }}">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span class="nav-text">Getting Started</span>
                            <span class="nav-badge">New</span>
                        </a>
                    </li>

                    <li class="nav-item {{ 'expanded' if 'playing' in (active_nav or '') }}">
                        <a href="#" class="nav-link" onclick="toggleNav(this.parentElement, event)">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                            </svg>
                            <span class="nav-text">Playing</span>
                            <svg class="nav-arrow" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </a>
                        <ul class="nav-sub">
                            <li class="nav-item">
                                <a href="{{ url_for('main.page', slug='game-basics') }}" class="nav-link {{ 'active' if current_slug == 'game-basics' }}">
                                    <span class="nav-text">Game Basics</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('main.page', slug='matchmaking') }}" class="nav-link {{ 'active' if current_slug == 'matchmaking' }}">
                                    <span class="nav-text">Matchmaking</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('main.page', slug='tutorials') }}" class="nav-link {{ 'active' if current_slug == 'tutorials' }}">
                                    <span class="nav-text">Tutorials</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('main.page', slug='replays') }}" class="nav-link {{ 'active' if current_slug == 'replays' }}">
                                    <span class="nav-text">Watching Replays</span>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item {{ 'expanded' if 'rules' in (active_nav or '') }}">
                        <a href="#" class="nav-link" onclick="toggleNav(this.parentElement, event)">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/>
                            </svg>
                            <span class="nav-text">Rules</span>
                            <svg class="nav-arrow" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </a>
                        <ul class="nav-sub">
                            <li class="nav-item">
                                <a href="{{ url_for('main.rules_detail', slug='general-rules') }}" class="nav-link {{ 'active' if current_slug == 'general-rules' }}">
                                    <span class="nav-text">General Rules</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('main.rules_detail', slug='vault-rules') }}" class="nav-link {{ 'active' if current_slug == 'vault-rules' }}">
                                    <span class="nav-text">Vault Rules</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('main.rules_detail', slug='chat-rules') }}" class="nav-link {{ 'active' if current_slug == 'chat-rules' }}">
                                    <span class="nav-text">Chat Rules</span>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item {{ 'expanded' if 'teams' in (active_nav or '') }}">
                        <a href="#" class="nav-link" onclick="toggleNav(this.parentElement, event)">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                            </svg>
                            <span class="nav-text">FAF Teams</span>
                            <svg class="nav-arrow" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </a>
                        <ul class="nav-sub">
                            {% for team in teams_nav|default([]) %}
                            <li class="nav-item">
                                <a href="{{ url_for('main.team_detail', slug=team.slug) }}" class="nav-link">
                                    <span class="nav-text">{{ team.name }}</span>
                                </a>
                            </li>
                            {% endfor %}
                            <li class="nav-item">
                                <a href="{{ url_for('main.teams') }}" class="nav-link">
                                    <span class="nav-text">View All Teams</span>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item {{ 'expanded' if 'creation' in (active_nav or '') }}">
                        <a href="#" class="nav-link" onclick="toggleNav(this.parentElement, event)">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M22 9V7h-2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2zm-4 10H4V5h14v14zM6 13h5v4H6zm6-6h4v3h-4zM6 7h5v5H6zm6 4h4v6h-4z"/>
                            </svg>
                            <span class="nav-text">Creation & Dev</span>
                            <svg class="nav-arrow" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </a>
                        <ul class="nav-sub">
                            <li class="nav-item">
                                <a href="{{ url_for('main.page', slug='mapping') }}" class="nav-link">
                                    <span class="nav-text">Mapping</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('main.page', slug='modding') }}" class="nav-link">
                                    <span class="nav-text">Modding</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{{ url_for('main.page', slug='development') }}" class="nav-link">
                                    <span class="nav-text">Development</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>

            <!-- Resources -->
            <nav class="sidebar-section">
                <div class="sidebar-title">Resources</div>
                <ul class="nav-tree">
                    <li class="nav-item">
                        <a href="https://discord.gg/mXahVSKGVb" target="_blank" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
                            </svg>
                            <span class="nav-text">Discord</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="https://forum.faforever.com/" target="_blank" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/>
                            </svg>
                            <span class="nav-text">Forums</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="https://github.com/FAForever" target="_blank" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            <span class="nav-text">GitHub</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="https://www.faforever.com/" target="_blank" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                            <span class="nav-text">FAF Website</span>
                        </a>
                    </li>
                </ul>
            </nav>

            {% if current_user.is_authenticated %}
            <!-- Editor Section -->
            <nav class="sidebar-section">
                <div class="sidebar-title">Editor</div>
                <ul class="nav-tree">
                    <li class="nav-item">
                        <a href="?edit=1" class="nav-link">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            <span class="nav-text">Enable Edit Mode</span>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </aside>

        <!-- Main Content -->
        <main class="main-wrapper">
            {% if editor_mode %}
            {% include 'components/editor_toolbar.html' %}
            {% endif %}

            <div class="main-content">
                <!-- Breadcrumbs -->
                {% if breadcrumbs %}
                <nav class="breadcrumbs">
                    {% for crumb in breadcrumbs %}
                    <span class="breadcrumb-item {{ 'active' if loop.last else '' }}">
                        {% if not loop.last %}
                        <a href="{{ crumb.url }}">{{ crumb.name }}</a>
                        {% else %}
                        {{ crumb.name }}
                        {% endif %}
                    </span>
                    {% if not loop.last %}
                    <span class="breadcrumb-separator">/</span>
                    {% endif %}
                    {% endfor %}
                </nav>
                {% endif %}

                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% if editor_mode %}
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
    {% endif %}

    <script>
        // Sidebar toggle
        function toggleNav(item, e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            item.classList.toggle('expanded');
        }

        // Keep parent expanded when on a sub-page
        document.querySelectorAll('.nav-sub .nav-link.active').forEach(link => {
            const parent = link.closest('.nav-item.expanded') || link.closest('ul.nav-sub')?.parentElement;
            if (parent) {
                parent.classList.add('expanded');
            }
        });

        // Prevent sub-item clicks from closing parent
        document.querySelectorAll('.nav-sub .nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });

        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
