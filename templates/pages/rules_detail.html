{% extends 'base.html' %}

{% block title %}{{ page.title }} - FAForever Wiki{% endblock %}

{% block content %}
<h1 class="section-title">{{ page.title }}</h1>

<div class="text-content editable-content" data-section="rules-content">
    {% if editor_mode %}
    <div id="rulesEditor">{{ content_html|safe }}</div>
    {% else %}
    {{ content_html|safe }}
    {% endif %}
</div>

{% if editor_mode %}
<input type="hidden" id="pageSlug" value="{{ page.slug }}">
{% endif %}

<div id="editModal"></div>
{% endblock %}

{% block scripts %}
{% if editor_mode %}
<script>
    // Initialize Quill editor for rules content
    const quill = new Quill('#rulesEditor', {
        theme: 'snow',
        modules: {
            toolbar: false // Use our custom toolbar
        }
    });

    // Connect toolbar buttons to Quill
    document.querySelectorAll('.editor-btn[data-command]').forEach(btn => {
        btn.addEventListener('click', () => {
            const command = btn.dataset.command;
            const value = btn.dataset.value;

            switch(command) {
                case 'bold':
                    quill.format('bold', !quill.getFormat().bold);
                    break;
                case 'italic':
                    quill.format('italic', !quill.getFormat().italic);
                    break;
                case 'underline':
                    quill.format('underline', !quill.getFormat().underline);
                    break;
                case 'strike':
                    quill.format('strike', !quill.getFormat().strike);
                    break;
                case 'list':
                    quill.format('list', value);
                    break;
                case 'align':
                    quill.format('align', value || false);
                    break;
                case 'link':
                    const url = prompt('Enter URL:');
                    if (url) quill.format('link', url);
                    break;
            }
        });
    });

    // Header select
    document.getElementById('headerSelect').addEventListener('change', (e) => {
        quill.format('header', e.target.value ? parseInt(e.target.value) : false);
    });

    // Font select
    document.getElementById('fontSelect').addEventListener('change', (e) => {
        quill.format('font', e.target.value || false);
    });

    // Save functionality
    document.getElementById('saveAllBtn').addEventListener('click', async () => {
        const content = quill.root.innerHTML;
        const saveUrl = '{{ url_for("api.update_page_content", slug=page.slug) }}';

        try {
            const response = await fetch(saveUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            });

            if (response.ok) {
                updateStatus('saved', 'Saved');
            } else {
                updateStatus('error', 'Error saving');
            }
        } catch (e) {
            console.error('Save error:', e);
            updateStatus('error', 'Error saving');
        }
    });

    function updateStatus(status, text) {
        const statusEl = document.getElementById('editorStatus');
        statusEl.className = 'editor-status ' + status;
        statusEl.querySelector('.editor-status-text').textContent = text;
    }
</script>
{% endif %}
{% endblock %}
